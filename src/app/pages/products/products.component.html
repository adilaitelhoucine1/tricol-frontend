<div>
  <div class="content-header">
    <h2 class="section-title">Gestion des Produits</h2>
    <button *ngIf="canCreateProduct()" class="btn-add" (click)="addProduct()">
      <span class="icon">➕</span>
      <span>Ajouter un Produit</span>
    </button>
  </div>

  <app-data-table
    [columns]="productColumns"
    [data]="products"
    [actions]="productActions"
    [loading]="loadingProducts"
    [emptyMessage]="'Aucun produit trouvé'"
    (rowClick)="onProductRowClick($event)">
  </app-data-table>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditMode ? 'Modifier le Produit' : 'Ajouter un Produit' }}</h2>
      <button class="btn-close" (click)="closeModal()">&times;</button>
    </div>

    <div class="modal-body">
      <form [formGroup]="productForm">
        <div class="form-group">
          <label for="reference">Référence <span class="required">*</span></label>
          <input type="text" id="reference" class="form-control" formControlName="reference" placeholder="Ex: PRD-001" [class.error]="productForm.get('reference')?.invalid && productForm.get('reference')?.touched" />
          <div class="error-message" *ngIf="productForm.get('reference')?.invalid && productForm.get('reference')?.touched">
            <span *ngIf="productForm.get('reference')?.errors?.['required']">La référence est obligatoire</span>
            <span *ngIf="productForm.get('reference')?.errors?.['maxlength']">La référence ne doit pas dépasser 50 caractères</span>
          </div>
        </div>

        <div class="form-group">
          <label for="nom">Nom du Produit <span class="required">*</span></label>
          <input type="text" id="nom" class="form-control" formControlName="nom" placeholder="Ex: Fil de coton blanc" [class.error]="productForm.get('nom')?.invalid && productForm.get('nom')?.touched" />
          <div class="error-message" *ngIf="productForm.get('nom')?.invalid && productForm.get('nom')?.touched">
            <span *ngIf="productForm.get('nom')?.errors?.['required']">Le nom est obligatoire</span>
            <span *ngIf="productForm.get('nom')?.errors?.['maxlength']">Le nom ne doit pas dépasser 200 caractères</span>
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description <span class="required">*</span></label>
          <textarea id="description" class="form-control" formControlName="description" placeholder="Ex: Fil de coton haute qualité pour textile" rows="3" [class.error]="productForm.get('description')?.invalid && productForm.get('description')?.touched"></textarea>
          <div class="error-message" *ngIf="productForm.get('description')?.invalid && productForm.get('description')?.touched">
            <span *ngIf="productForm.get('description')?.errors?.['required']">La description est obligatoire</span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="prixUnitaire">Prix Unitaire (DH) <span class="required">*</span></label>
            <input type="number" id="prixUnitaire" class="form-control" formControlName="prixUnitaire" placeholder="Ex: 25.50" step="0.01" min="0" [class.error]="productForm.get('prixUnitaire')?.invalid && productForm.get('prixUnitaire')?.touched" />
            <div class="error-message" *ngIf="productForm.get('prixUnitaire')?.invalid && productForm.get('prixUnitaire')?.touched">
              <span *ngIf="productForm.get('prixUnitaire')?.errors?.['required']">Le prix est obligatoire</span>
              <span *ngIf="productForm.get('prixUnitaire')?.errors?.['min']">Le prix doit être positif</span>
            </div>
          </div>

          <div class="form-group">
            <label for="categorie">Catégorie <span class="required">*</span></label>
            <input type="text" id="categorie" class="form-control" formControlName="categorie" placeholder="Ex: Matière première" [class.error]="productForm.get('categorie')?.invalid && productForm.get('categorie')?.touched" />
            <div class="error-message" *ngIf="productForm.get('categorie')?.invalid && productForm.get('categorie')?.touched">
              <span *ngIf="productForm.get('categorie')?.errors?.['required']">La catégorie est obligatoire</span>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="stockInitial">Stock Initial <span class="required">*</span></label>
            <input type="number" id="stockInitial" class="form-control" formControlName="stockInitial" placeholder="Ex: 100" min="0" [class.error]="productForm.get('stockInitial')?.invalid && productForm.get('stockInitial')?.touched" />
            <div class="error-message" *ngIf="productForm.get('stockInitial')?.invalid && productForm.get('stockInitial')?.touched">
              <span *ngIf="productForm.get('stockInitial')?.errors?.['required']">Le stock initial est obligatoire</span>
              <span *ngIf="productForm.get('stockInitial')?.errors?.['min']">Le stock doit être positif</span>
            </div>
          </div>

          <div class="form-group">
            <label for="pointDeCommande">Point de Commande <span class="required">*</span></label>
            <input type="number" id="pointDeCommande" class="form-control" formControlName="pointDeCommande" placeholder="Ex: 20" min="0" [class.error]="productForm.get('pointDeCommande')?.invalid && productForm.get('pointDeCommande')?.touched" />
            <div class="error-message" *ngIf="productForm.get('pointDeCommande')?.invalid && productForm.get('pointDeCommande')?.touched">
              <span *ngIf="productForm.get('pointDeCommande')?.errors?.['required']">Le point de commande est obligatoire</span>
              <span *ngIf="productForm.get('pointDeCommande')?.errors?.['min']">Le point de commande doit être positif</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="uniteMesure">Unité de Mesure <span class="required">*</span></label>
          <input type="text" id="uniteMesure" class="form-control" formControlName="uniteMesure" placeholder="Ex: bobine" [class.error]="productForm.get('uniteMesure')?.invalid && productForm.get('uniteMesure')?.touched" />
          <div class="error-message" *ngIf="productForm.get('uniteMesure')?.invalid && productForm.get('uniteMesure')?.touched">
            <span *ngIf="productForm.get('uniteMesure')?.errors?.['required']">L'unité de mesure est obligatoire</span>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
          <button type="button" class="btn btn-primary" [disabled]="productForm.invalid || isSubmitting" (click)="submitProduct()">
            {{ isSubmitting ? 'Enregistrement...' : (isEditMode ? 'Modifier' : 'Ajouter') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
