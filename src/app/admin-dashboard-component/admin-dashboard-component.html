<div class="admin-dashboard">
  <!-- Sidebar -->
  <aside class="sidebar" [class.sidebar-closed]="!sidebarOpen">
    <div class="sidebar-header">
      <div class="logo">
        <h2 *ngIf="sidebarOpen">TRICOL</h2>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a class="nav-item" [class.active]="activeSection === 'suppliers'" (click)="setActiveSection('suppliers')">
        <span *ngIf="sidebarOpen">Fournisseurs</span>
      </a>
      <a class="nav-item" [class.active]="activeSection === 'products'" (click)="setActiveSection('products')">
        <span *ngIf="sidebarOpen">Produits</span>
      </a>
      <a class="nav-item" [class.active]="activeSection === 'orders'" (click)="setActiveSection('orders')">
        <span *ngIf="sidebarOpen">Commandes Fournisseurs</span>
      </a>
      <a class="nav-item" [class.active]="activeSection === 'stock'" (click)="setActiveSection('stock')">
        <span *ngIf="sidebarOpen">Gestion de Stock</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <button class="nav-item logout-btn" (click)="logout()">
        <span *ngIf="sidebarOpen">D√©connexion</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <button class="toggle-btn" (click)="toggleSidebar()">‚ò∞</button>
      <h1 class="page-title">Administration - TRICOL</h1>
    </header>

    <div class="content">
      <!-- Suppliers Section -->
      <div *ngIf="activeSection === 'suppliers'">
        <div class="content-header">
          <h2 class="section-title">Gestion des Fournisseurs</h2>
          <button class="btn-add" (click)="addSupplier()">
            <span class="icon">‚ûï</span>
            <span>Ajouter un Fournisseur</span>
          </button>
        </div>

        <app-data-table
          [columns]="supplierColumns"
          [data]="suppliers"
          [actions]="supplierActions"
          [loading]="loadingSuppliers"
          [emptyMessage]="'Aucun fournisseur trouv√©'"
          (rowClick)="onSupplierRowClick($event)">
        </app-data-table>
      </div>

      <!-- Products Section -->
      <div *ngIf="activeSection === 'products'">
        <div class="content-header">
          <h2 class="section-title">Gestion des Produits</h2>
          <button class="btn-add" (click)="addProduct()">
            <span class="icon">‚ûï</span>
            <span>Ajouter un Produit</span>
          </button>
        </div>

        <app-data-table
          [columns]="productColumns"
          [data]="products"
          [actions]="productActions"
          [loading]="loadingProducts"
          [emptyMessage]="'Aucun produit trouv√©'"
          (rowClick)="onProductRowClick($event)">
        </app-data-table>
      </div>

      <!-- Orders Section -->
      <div *ngIf="activeSection === 'orders'">
        <div class="content-header">
          <h2 class="section-title">Gestion des Commandes Fournisseurs</h2>
          <button class="btn-add" (click)="addOrder()">
            <span class="icon">‚ûï</span>
            <span>Ajouter une Commande</span>
          </button>
        </div>

        <app-data-table
          [columns]="orderColumns"
          [data]="orders"
          [actions]="orderActions"
          [loading]="loadingOrders"
          [emptyMessage]="'Aucune commande trouv√©e'"
          (rowClick)="onOrderRowClick($event)">
        </app-data-table>
      </div>

      <!-- Stock Section -->
      <div *ngIf="activeSection === 'stock'">
        <div class="content-header">
          <h2 class="section-title">Gestion de Stock</h2>
          <button class="btn-add" (click)="getEtatGlobal()">
            <span class="icon">üîÑ</span>
            <span>Actualiser</span>
          </button>
        </div>

        <app-data-table
          [columns]="stockColumns"
          [data]="etatGlobal"
          [loading]="loadingStock"
          [emptyMessage]="'Aucun stock trouv√©'">
        </app-data-table>

        <div class="stock-additional-info">
          <div class="stock-card">
            <h3>Stock par Produit</h3>
            <select class="form-control" (change)="getStockByProduit(+$any($event.target).value)">
              <option value="">S√©lectionner un produit</option>
              <option *ngFor="let product of products" [value]="product.id">{{ product.nom }}</option>
            </select>
            <div *ngIf="stockByProduit" class="card-content">
              <p><strong>Reference:</strong> {{ stockByProduit.reference }}</p>
              <p><strong>Quantite Totale:</strong> {{ stockByProduit.quantiteTotale }}</p>
              <p><strong>Valorisation Totale:</strong> {{ stockByProduit.valorisationTotale }}</p>
            </div>
          </div>

          <div class="stock-card">
            <h3>Alertes Stock</h3>
            <button class="btn-refresh" (click)="getAlertes()">üîÑ Actualiser</button>
            <div *ngIf="alertes.length > 0" class="card-content">
              <div *ngFor="let alerte of alertes" class="alert-item">
                <p><strong>{{ alerte.nom }}</strong> ({{ alerte.reference }})</p>
                <p>Stock: {{ alerte.stockActuel }} / Point de commande: {{ alerte.pointDeCommande }}</p>
                <p class="text-danger">Manquant: {{ alerte.manquant }} unit√©s</p>
              </div>
            </div>
            <p *ngIf="alertes.length === 0" class="no-alert">Aucune alerte</p>
          </div>

          <div class="stock-card">
            <h3>Valorisation</h3>
            <button class="btn-refresh" (click)="getValorisation()">üîÑ Actualiser</button>
            <div *ngIf="valorisation" class="card-content">
              <p class="valorisation-message">{{ valorisation }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add/Edit Supplier Modal -->
  <div class="modal-overlay" *ngIf="showModal && modalType === 'supplier'" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditMode ? 'Modifier le Fournisseur' : 'Ajouter un Fournisseur' }}</h2>
        <button class="btn-close" (click)="closeModal()">&times;</button>
      </div>

      <div class="modal-body">
        <form [formGroup]="supplierForm">
          <div class="form-group">
            <label for="raisonSociale">Raison Sociale <span class="required">*</span></label>
            <input type="text" id="raisonSociale" class="form-control" formControlName="raisonSociale" placeholder="Ex: SARL ABC" [class.error]="supplierForm.get('raisonSociale')?.invalid && supplierForm.get('raisonSociale')?.touched" />
            <div class="error-message" *ngIf="supplierForm.get('raisonSociale')?.invalid && supplierForm.get('raisonSociale')?.touched">
              <span *ngIf="supplierForm.get('raisonSociale')?.errors?.['required']">La raison sociale est obligatoire</span>
              <span *ngIf="supplierForm.get('raisonSociale')?.errors?.['maxlength']">La raison sociale ne doit pas d√©passer 200 caract√®res</span>
            </div>
          </div>

          <div class="form-group">
            <label for="adresse">Adresse <span class="required">*</span></label>
            <textarea id="adresse" class="form-control" formControlName="adresse" placeholder="Ex: 123 Rue de la R√©publique" rows="3" [class.error]="supplierForm.get('adresse')?.invalid && supplierForm.get('adresse')?.touched"></textarea>
            <div class="error-message" *ngIf="supplierForm.get('adresse')?.invalid && supplierForm.get('adresse')?.touched">
              <span *ngIf="supplierForm.get('adresse')?.errors?.['required']">L'adresse est obligatoire</span>
            </div>
          </div>

          <div class="form-group">
            <label for="ville">Ville <span class="required">*</span></label>
            <input type="text" id="ville" class="form-control" formControlName="ville" placeholder="Ex: Casablanca" [class.error]="supplierForm.get('ville')?.invalid && supplierForm.get('ville')?.touched" />
            <div class="error-message" *ngIf="supplierForm.get('ville')?.invalid && supplierForm.get('ville')?.touched">
              <span *ngIf="supplierForm.get('ville')?.errors?.['required']">La ville est obligatoire</span>
              <span *ngIf="supplierForm.get('ville')?.errors?.['maxlength']">La ville ne doit pas d√©passer 100 caract√®res</span>
            </div>
          </div>

          <div class="form-group">
            <label for="personneContact">Personne de Contact <span class="required">*</span></label>
            <input type="text" id="personneContact" class="form-control" formControlName="personneContact" placeholder="Ex: Ahmed Benali" [class.error]="supplierForm.get('personneContact')?.invalid && supplierForm.get('personneContact')?.touched" />
            <div class="error-message" *ngIf="supplierForm.get('personneContact')?.invalid && supplierForm.get('personneContact')?.touched">
              <span *ngIf="supplierForm.get('personneContact')?.errors?.['required']">Le nom de la personne de contact est obligatoire</span>
              <span *ngIf="supplierForm.get('personneContact')?.errors?.['maxlength']">Le nom ne doit pas d√©passer 150 caract√®res</span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="email">Email <span class="required">*</span></label>
              <input type="email" id="email" class="form-control" formControlName="email" placeholder="Ex: contact@exemple.com" [class.error]="supplierForm.get('email')?.invalid && supplierForm.get('email')?.touched" />
              <div class="error-message" *ngIf="supplierForm.get('email')?.invalid && supplierForm.get('email')?.touched">
                <span *ngIf="supplierForm.get('email')?.errors?.['required']">L'email est obligatoire</span>
                <span *ngIf="supplierForm.get('email')?.errors?.['email']">Format d'email invalide</span>
              </div>
            </div>

            <div class="form-group">
              <label for="telephone">T√©l√©phone <span class="required">*</span></label>
              <input type="tel" id="telephone" class="form-control" formControlName="telephone" placeholder="Ex: +212600000000" [class.error]="supplierForm.get('telephone')?.invalid && supplierForm.get('telephone')?.touched" />
              <div class="error-message" *ngIf="supplierForm.get('telephone')?.invalid && supplierForm.get('telephone')?.touched">
                <span *ngIf="supplierForm.get('telephone')?.errors?.['required']">Le t√©l√©phone est obligatoire</span>
                <span *ngIf="supplierForm.get('telephone')?.errors?.['pattern']">Format de t√©l√©phone invalide (10-15 chiffres)</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="ice">ICE (Identifiant Commun de l'Entreprise) <span class="required">*</span></label>
            <input type="text" id="ice" class="form-control" formControlName="ice" placeholder="Ex: 001234567890123 (15 caract√®res)" maxlength="15" [class.error]="supplierForm.get('ice')?.invalid && supplierForm.get('ice')?.touched" />
            <div class="error-message" *ngIf="supplierForm.get('ice')?.invalid && supplierForm.get('ice')?.touched">
              <span *ngIf="supplierForm.get('ice')?.errors?.['required']">L'ICE est obligatoire</span>
              <span *ngIf="supplierForm.get('ice')?.errors?.['minlength'] || supplierForm.get('ice')?.errors?.['maxlength']">L'ICE doit contenir exactement 15 caract√®res</span>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
            <button type="button" class="btn btn-primary" [disabled]="supplierForm.invalid || isSubmitting" (click)="submitSupplier()">
              {{ isSubmitting ? 'Enregistrement...' : (isEditMode ? 'Modifier' : 'Ajouter') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add/Edit Product Modal -->
  <div class="modal-overlay" *ngIf="showModal && modalType === 'product'" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditMode ? 'Modifier le Produit' : 'Ajouter un Produit' }}</h2>
        <button class="btn-close" (click)="closeModal()">&times;</button>
      </div>

      <div class="modal-body">
        <form [formGroup]="productForm">
          <div class="form-group">
            <label for="reference">R√©f√©rence <span class="required">*</span></label>
            <input type="text" id="reference" class="form-control" formControlName="reference" placeholder="Ex: PRD-001" [class.error]="productForm.get('reference')?.invalid && productForm.get('reference')?.touched" />
            <div class="error-message" *ngIf="productForm.get('reference')?.invalid && productForm.get('reference')?.touched">
              <span *ngIf="productForm.get('reference')?.errors?.['required']">La r√©f√©rence est obligatoire</span>
              <span *ngIf="productForm.get('reference')?.errors?.['maxlength']">La r√©f√©rence ne doit pas d√©passer 50 caract√®res</span>
            </div>
          </div>

          <div class="form-group">
            <label for="nom">Nom du Produit <span class="required">*</span></label>
            <input type="text" id="nom" class="form-control" formControlName="nom" placeholder="Ex: Fil de coton blanc" [class.error]="productForm.get('nom')?.invalid && productForm.get('nom')?.touched" />
            <div class="error-message" *ngIf="productForm.get('nom')?.invalid && productForm.get('nom')?.touched">
              <span *ngIf="productForm.get('nom')?.errors?.['required']">Le nom est obligatoire</span>
              <span *ngIf="productForm.get('nom')?.errors?.['maxlength']">Le nom ne doit pas d√©passer 200 caract√®res</span>
            </div>
          </div>

          <div class="form-group">
            <label for="description">Description <span class="required">*</span></label>
            <textarea id="description" class="form-control" formControlName="description" placeholder="Ex: Fil de coton haute qualit√© pour textile" rows="3" [class.error]="productForm.get('description')?.invalid && productForm.get('description')?.touched"></textarea>
            <div class="error-message" *ngIf="productForm.get('description')?.invalid && productForm.get('description')?.touched">
              <span *ngIf="productForm.get('description')?.errors?.['required']">La description est obligatoire</span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="prixUnitaire">Prix Unitaire (DH) <span class="required">*</span></label>
              <input type="number" id="prixUnitaire" class="form-control" formControlName="prixUnitaire" placeholder="Ex: 25.50" step="0.01" min="0" [class.error]="productForm.get('prixUnitaire')?.invalid && productForm.get('prixUnitaire')?.touched" />
              <div class="error-message" *ngIf="productForm.get('prixUnitaire')?.invalid && productForm.get('prixUnitaire')?.touched">
                <span *ngIf="productForm.get('prixUnitaire')?.errors?.['required']">Le prix est obligatoire</span>
                <span *ngIf="productForm.get('prixUnitaire')?.errors?.['min']">Le prix doit √™tre positif</span>
              </div>
            </div>

            <div class="form-group">
              <label for="categorie">Cat√©gorie <span class="required">*</span></label>
              <input type="text" id="categorie" class="form-control" formControlName="categorie" placeholder="Ex: Mati√®re premi√®re" [class.error]="productForm.get('categorie')?.invalid && productForm.get('categorie')?.touched" />
              <div class="error-message" *ngIf="productForm.get('categorie')?.invalid && productForm.get('categorie')?.touched">
                <span *ngIf="productForm.get('categorie')?.errors?.['required']">La cat√©gorie est obligatoire</span>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="stockInitial">Stock Initial <span class="required">*</span></label>
              <input type="number" id="stockInitial" class="form-control" formControlName="stockInitial" placeholder="Ex: 100" min="0" [class.error]="productForm.get('stockInitial')?.invalid && productForm.get('stockInitial')?.touched" />
              <div class="error-message" *ngIf="productForm.get('stockInitial')?.invalid && productForm.get('stockInitial')?.touched">
                <span *ngIf="productForm.get('stockInitial')?.errors?.['required']">Le stock initial est obligatoire</span>
                <span *ngIf="productForm.get('stockInitial')?.errors?.['min']">Le stock doit √™tre positif</span>
              </div>
            </div>

            <div class="form-group">
              <label for="pointDeCommande">Point de Commande <span class="required">*</span></label>
              <input type="number" id="pointDeCommande" class="form-control" formControlName="pointDeCommande" placeholder="Ex: 20" min="0" [class.error]="productForm.get('pointDeCommande')?.invalid && productForm.get('pointDeCommande')?.touched" />
              <div class="error-message" *ngIf="productForm.get('pointDeCommande')?.invalid && productForm.get('pointDeCommande')?.touched">
                <span *ngIf="productForm.get('pointDeCommande')?.errors?.['required']">Le point de commande est obligatoire</span>
                <span *ngIf="productForm.get('pointDeCommande')?.errors?.['min']">Le point de commande doit √™tre positif</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="uniteMesure">Unit√© de Mesure <span class="required">*</span></label>
            <input type="text" id="uniteMesure" class="form-control" formControlName="uniteMesure" placeholder="Ex: bobine" [class.error]="productForm.get('uniteMesure')?.invalid && productForm.get('uniteMesure')?.touched" />
            <div class="error-message" *ngIf="productForm.get('uniteMesure')?.invalid && productForm.get('uniteMesure')?.touched">
              <span *ngIf="productForm.get('uniteMesure')?.errors?.['required']">L'unit√© de mesure est obligatoire</span>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
            <button type="button" class="btn btn-primary" [disabled]="productForm.invalid || isSubmitting" (click)="submitProduct()">
              {{ isSubmitting ? 'Enregistrement...' : (isEditMode ? 'Modifier' : 'Ajouter') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add/Edit Order Modal -->
  <div class="modal-overlay" *ngIf="showModal && modalType === 'order'" (click)="closeModal()">
    <div class="modal-content" style="max-width: 700px;" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditMode ? 'Modifier la Commande' : 'Ajouter une Commande' }}</h2>
        <button class="btn-close" (click)="closeModal()">&times;</button>
      </div>

      <div class="modal-body">
        <form [formGroup]="orderForm">
          <div class="form-group">
            <label for="numeroCommande">N¬∞ Commande <span class="required">*</span></label>
            <input type="text" id="numeroCommande" class="form-control" formControlName="numeroCommande" placeholder="Ex: CMD-2024-001" />
          </div>

          <div class="form-group">
            <label for="fournisseurId">Fournisseur <span class="required">*</span></label>
            <select id="fournisseurId" class="form-control" formControlName="fournisseurId">
              <option value="">S√©lectionnez un fournisseur</option>
              <option *ngFor="let supplier of suppliers" [value]="supplier.id">{{ supplier.raisonSociale }}</option>
            </select>
          </div>

          <div class="form-group">
            <label for="dateCommande">Date Commande <span class="required">*</span></label>
            <input type="date" id="dateCommande" class="form-control" formControlName="dateCommande" />
          </div>

          <div class="form-group">
            <label for="produitId">Produit <span class="required">*</span></label>
            <select id="produitId" class="form-control" formControlName="produitId">
              <option value="">S√©lectionnez un produit</option>
              <option *ngFor="let product of products" [value]="product.id">{{ product.nom }}</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="quantite">Quantit√© <span class="required">*</span></label>
              <input type="number" id="quantite" class="form-control" formControlName="quantite" min="1" />
            </div>

            <div class="form-group">
              <label for="prixUnitaire">Prix Unitaire <span class="required">*</span></label>
              <input type="number" id="prixUnitaire" class="form-control" formControlName="prixUnitaire" step="0.01" min="0" />
            </div>
          </div>

          <div class="form-group">
            <label for="observations">Observations</label>
            <textarea id="observations" class="form-control" formControlName="observations" rows="3" placeholder="Observations..."></textarea>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
            <button type="button" class="btn btn-primary" [disabled]="orderForm.invalid || isSubmitting" (click)="submitOrder()">
              {{ isSubmitting ? 'Enregistrement...' : 'Cr√©er la Commande' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
